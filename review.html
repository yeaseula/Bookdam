<!DOCTYPE html>
<html lang="ko-KR">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>책담-책에 담긴 당신만의 이야기</title>

        <!--css-->
        <link rel="stylesheet" type="text/css" href="css/reset.css">
        <link rel="stylesheet" href="css/fonts.css">
        <link rel="stylesheet" type="text/css" href="css/common.css">
        <link rel="stylesheet" type="text/css" href="css/page.css">

        <!--cdn-->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.7.5/lottie.min.js"></script>

        <!--javascript-->
        <script src="js/common.js"></script>
        <script src="js/page.js"></script>
    </head>
    <body>
        <div class="common-wrap">
            <header>
                <div class="header-depth">
                    <a href="javascript:void(0)"><img src="assets/img/back-arrow.svg" alt="뒤로가기"></a>
                    <p class="page-title sd-b">나의 리뷰</p>
                    <div class="icon-box">
                        <a href=""><img src="assets/img/chart-icon.svg" alt="나의 취향 통계"></a>
                        <a href=""><img src="assets/img/search-icon.svg" alt="독서리뷰 검색하기"></a>
                    </div>
                </div>
            </header>
            <div class="sub-wrap">
                <div class="my-review-wrap">
                    <section>
                        <h2 class="sr-only">내가 쓴 리뷰 리스트</h2>
                        <div class="my-review-title">
                            <p class="total-count">총 <span>8</span>개</p>
                            <a href="javascript:void(0)" class="go_my_librery"><span>내 서재</span></a>
                        </div>
                        <div class="my-review-list">

                        </div>
                    </section>
                </div>
            </div>
            <footer id="footer"></footer>
        </div>
        <nav id="bottom_navigator"></nav>

        <script>
            const currentpage = 'review';

            const sheetId = '1EiQpFub62jL2VZOULwozl_f3hkz1J-wVec9rcSbR5CU';
            const gid = '1116419757';
            const kakaoKey = '7ef7831f0d6b81e970b30f0cdfa6a4a2'; // REST 키

            //kakao api로 북커버 불러오기
            async function fetchBookCover(title,author) {
                try {
                    const query = `${title} ${author}`;
                    const apiUrl = `https://dapi.kakao.com/v3/search/book?target=all&query=${encodeURIComponent(query)}`;

                    const res = await fetch(apiUrl, {
                        headers: {
                            Authorization: `KakaoAK ${kakaoKey}`
                        }
                    });
                    const data = await res.json();
                    const filtered = data.documents.find(book =>
                        book.title.includes(title) && book.authors.join(',').includes(author)
                    );

                    return (filtered || data.documents[0])?.thumbnail || '';

                    return filtered || data.documents[0]; // 없으면 첫 번째 결과라도 반환
                    } catch (e) {
                        console.error('카카오 API 오류:', e);
                        return '';
                    }
                }

                //구글 시트에서 데이터 불러오기
                async function loadReviews() {
                    const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&gid=${gid}`;
                    const text = await fetch(url).then(r => r.text());
                    const json = JSON.parse(
                    text
                        .replace("/*O_o*/", "")
                        .replace("google.visualization.Query.setResponse(", "")
                        .slice(0, -2)
                    );
                    const rows = json.table.rows;

                    rows.sort((a, b) => {
                    const rawA = a.c[0]?.v || '';
                    const rawB = b.c[0]?.v || '';
                    const parseDate = (raw) => {
                        const match = raw.match(/Date\((\d+),\s*(\d+),\s*(\d+),\s*(\d+),\s*(\d+),\s*(\d+)\)/);
                        if (!match) return new Date(0);
                        const [ , y, m, d, h, min, s ] = match.map(Number);
                        return new Date(y, m, d, h, min, s);
                    };
                    return parseDate(rawB) - parseDate(rawA);
                    });

                    const container = document.querySelector('.my-review-list');
                    container.innerHTML = '';

                    for (const row of rows) {
                        const title = row.c[2]?.v || '';
                        const oneline = row.c[6]?.v || '';
                        const author = row.c[3]?.v || '';
                        const rawDate = row.c[0]?.v || '';

                        let formattedDate = '';

                        const dateMatch = rawDate.match(/Date\((\d+),\s*(\d+),\s*(\d+),\s*(\d+),\s*(\d+),\s*(\d+)\)/);

                        if (dateMatch) {
                            const year = parseInt(dateMatch[1]);
                            const month = parseInt(dateMatch[2]); // 0부터 시작
                            const day = parseInt(dateMatch[3]);
                            const hour = parseInt(dateMatch[4]);
                            const minute = parseInt(dateMatch[5]);
                            const second = parseInt(dateMatch[6]);

                            const dateObj = new Date(year, month, day, hour, minute, second);

                        // 원하는 포맷으로 변환 (예: 2025-07-23 09:20)
                            const formattedMonth = String(dateObj.getMonth() + 1).padStart(2, '0');
                            const formattedDay = String(dateObj.getDate()).padStart(2, '0');
                            const formattedHour = String(dateObj.getHours()).padStart(2, '0');
                            const formattedMinute = String(dateObj.getMinutes()).padStart(2, '0');

                            formattedDate = `${dateObj.getFullYear()}-${formattedMonth}-${formattedDay} ${formattedHour}:${formattedMinute}`;
                        } else {
                            console.warn('날짜 파싱 실패:', rawDate);
                        }


                        const thumb = await fetchBookCover(title,author);
                        const item = document.createElement('div');
                        item.className = 'list-item';
                        item.innerHTML = `
                            <a href="#"></a>
                            <div class="list-img" style="background-image:url('${thumb}')"></div>
                            <div class="list-cont">
                            <p class="list-title">${title}</p>
                            <p class="list-summary">${oneline}</p>
                            <p class="list-date">${formattedDate}</p>
                            </div>`;
                        container.appendChild(item);
                        }
                }

                loadReviews();

        </script>
    </body>
</html>